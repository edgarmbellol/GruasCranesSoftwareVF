<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Horas - {{ equipo.Placa }} - GRÚAS CRANES S.A.S</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #27AE60;
            --primary-dark: #229954;
            --secondary-color: #F1C40F;
            --dark-color: #111111;
            --light-color: #FFFFFF;
            --text-color: #2C3E50;
            --text-light: #7F8C8D;
            --border-color: #BDC3C7;
            --light-bg: #F8F9FA;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
        }

        body {
            background: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: var(--gradient-primary);
            color: var(--light-color);
            padding: 1rem 0;
            box-shadow: var(--shadow-sm);
        }

        .equipo-info {
            background: var(--light-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-color);
        }

        .equipo-details h4 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .equipo-specs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .spec-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .spec-item i {
            color: var(--primary-color);
            width: 16px;
        }

        .empleado-details h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empleado-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .empleado-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1rem;
        }

        .empleado-doc {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-container {
            background: var(--light-color);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(39, 174, 96, 0.25);
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            font-weight: 600;
            padding: 0.75rem 2rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .hidden-field {
            display: none;
        }

        .cargo-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--light-bg);
            border-radius: 50%;
            margin-right: 1rem;
        }

        .equipo-badge {
            background: var(--secondary-color);
            color: var(--dark-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .btn-volver {
            transition: all 0.3s ease;
            border: 2px solid var(--secondary-color);
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .btn-volver:hover {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            transform: translateX(-2px);
        }
        
        .btn-volver-header {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--light-color);
        }
        
        .btn-volver-header:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--light-color);
        }
        
        .cargo-readonly {
            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8F0 100%);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .cargo-readonly i {
            color: var(--primary-color);
        }
        
        .estado-readonly {
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            border: 2px solid #6C757D;
            color: #495057;
            font-weight: 600;
        }
        
        .estado-readonly i {
            color: #6C757D;
        }
        
        .cliente-readonly {
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            border: 2px solid #2196F3;
            color: #1976D2;
            font-weight: 600;
        }
        
        .cliente-readonly i {
            color: #2196F3;
        }
        
        .entrada-reference {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8F0 100%);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .entrada-reference i {
            color: var(--primary-color);
        }
        
        .validation-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .validation-message.valid {
            background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .validation-message.invalid {
            background: linear-gradient(135deg, #F8D7DA 0%, #F5C6CB 100%);
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .validation-message i {
            margin-right: 0.5rem;
        }
        
        .entrada-info-section {
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            border: 2px solid #2196F3;
            border-radius: 15px;
        }
        
        .entrada-info-section .section-title {
            color: #1976D2;
            font-weight: 600;
        }
        
        .entrada-info-section .alert {
            border: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 0.75rem;
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload:hover .file-upload-label {
            border-color: var(--primary-color);
            background: rgba(39, 174, 96, 0.1);
        }

        .image-preview {
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--border-color);
        }

        .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        .location-info {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .location-info i {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 1rem;
                margin: 1rem;
            }
            
            .equipo-info {
                padding: 1rem;
            }

            .equipo-specs {
                gap: 0.25rem;
            }

            .spec-item {
                font-size: 0.85rem;
            }

            .empleado-info {
                gap: 0.1rem;
            }

            .empleado-name {
                font-size: 0.9rem;
            }

            .empleado-doc {
                font-size: 0.8rem;
            }
        }
        
        /* Estilos para campo cliente auto-asignado */
        .cliente-auto-asignado {
            background-color: #f8f9fa !important;
            border: 2px solid #28a745 !important;
            color: #155724 !important;
            font-weight: 500 !important;
        }
        
        .cliente-auto-asignado:focus {
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        }
        
        .cliente-auto-asignado::after {
            content: " (Auto-asignado)";
            font-size: 0.875rem;
            color: #28a745;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Header Principal -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <a href="{{ url_for('qr_equipos') }}" class="btn btn-volver me-3" title="Ver Códigos QR">
                            <i class="fas fa-qrcode me-2"></i>
                            Ver Códigos QR
                        </a>
                        <div>
                            <h1 class="mb-0">
                                <i class="fas fa-clock me-3"></i>
                                {{ 'Registro de Salida' if entrada_pendiente else 'Registro de Entrada' }}
                            </h1>
                            <p class="mb-0">Sistema de control de tiempo de trabajo</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="equipo-badge">
                        <i class="fas fa-crane me-2"></i>
                        {{ equipo.Placa }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Información del equipo y empleado -->
        <div class="equipo-info">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="equipo-details">
                        <h4 class="mb-2">
                            <i class="fas fa-crane me-2"></i>
                            {{ equipo.Placa }} - {{ equipo.tipo_equipo.descripcion if equipo.tipo_equipo else 'N/A' }}
                        </h4>
                        <div class="equipo-specs">
                            <span class="spec-item">
                                <i class="fas fa-tag me-1"></i>
                                <strong>Marca:</strong> {{ equipo.marca.DescripcionMarca if equipo.marca else 'N/A' }}
                            </span>
                            <span class="spec-item">
                                <i class="fas fa-weight me-1"></i>
                                <strong>Capacidad:</strong> {{ equipo.Capacidad }} toneladas
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="empleado-details">
                        <h5 class="mb-2">
                            <i class="fas fa-user me-2"></i>
                            Empleado
                        </h5>
                        <div class="empleado-info">
                            <span class="empleado-name">{{ empleado.nombre }}</span>
                            <span class="empleado-doc">{{ empleado.documento }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensajes -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Formulario -->
        <div class="form-container">
            <form method="POST" action="{{ url_for('procesar_registro_horas', equipo_id=equipo.IdEquipo) }}" enctype="multipart/form-data" id="registroForm">
                {{ form.hidden_tag() }}
                
                <!-- Campos ocultos necesarios -->
                <input type="hidden" name="TipoRegistro" value="{{ form.TipoRegistro.data }}">
                <input type="hidden" name="IdEquipo" value="{{ form.IdEquipo.data }}">
                <input type="hidden" name="IdEmpleado" value="{{ form.IdEmpleado.data }}">
                
                <!-- Información básica -->
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Información Básica
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.FechaEmpleado.label(class="form-label") }} <span class="text-danger">*</span>
                            {{ form.FechaEmpleado(class="form-control" + (" is-invalid" if form.FechaEmpleado.errors else ""), id="FechaEmpleado", onchange="validarFechaHora()") }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Fecha actual preestablecida - puedes modificarla si es necesario
                            </small>
                            <div id="fecha-validation" class="validation-message" style="display: none;"></div>
                            {% if form.FechaEmpleado.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.FechaEmpleado.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.HoraEmpleado.label(class="form-label") }} <span class="text-danger">*</span>
                            {{ form.HoraEmpleado(class="form-control" + (" is-invalid" if form.HoraEmpleado.errors else ""), id="HoraEmpleado", onchange="validarFechaHora()") }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Hora actual preestablecida - puedes modificarla si es necesario
                            </small>
                            <div id="hora-validation" class="validation-message" style="display: none;"></div>
                            {% if form.HoraEmpleado.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.HoraEmpleado.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Empleado</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                                <i class="fas fa-user me-2"></i>
                                <strong>{{ empleado.nombre }}</strong> - {{ empleado.documento }}
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.IdCargo.label(class="form-label") }} <span class="text-danger">*</span>
                            {% if form.IdCargo.render_kw and form.IdCargo.render_kw.get('readonly') %}
                                <!-- Mostrar el cargo como texto no editable -->
                                <div class="form-control-plaintext cargo-readonly p-3 rounded">
                                    <i class="fas fa-user-tie me-2"></i>
                                    <strong>{{ cargo_nombre or 'N/A' }}</strong>
                                </div>
                                <!-- Campo oculto para enviar el valor -->
                                <input type="hidden" name="IdCargo" value="{{ form.IdCargo.data }}">
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    El cargo se mantiene igual al de la entrada
                                </small>
                            {% else %}
                                {{ form.IdCargo(class="form-select" + (" is-invalid" if form.IdCargo.errors else "")) }}
                            {% endif %}
                            {% if form.IdCargo.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.IdCargo.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.IdEstadoEquipo.label(class="form-label") }} <span class="text-danger">*</span>
                            {% if form.IdEstadoEquipo.render_kw and form.IdEstadoEquipo.render_kw.get('readonly') %}
                                <!-- Mostrar el estado como texto no editable -->
                                <div class="form-control-plaintext estado-readonly p-3 rounded">
                                    <i class="fas fa-cog me-2"></i>
                                    <strong>
                                        {% for id_estado, nombre_estado in form.IdEstadoEquipo.choices %}
                                            {% if id_estado == form.IdEstadoEquipo.data %}
                                                {{ nombre_estado }}
                                            {% endif %}
                                        {% endfor %}
                                    </strong>
                                </div>
                                <!-- Campo oculto para enviar el valor -->
                                <input type="hidden" name="IdEstadoEquipo" value="{{ form.IdEstadoEquipo.data }}">
                            {% else %}
                                {{ form.IdEstadoEquipo(class="form-select" + (" is-invalid" if form.IdEstadoEquipo.errors else "")) }}
                                {% if form.IdEstadoEquipo.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.IdEstadoEquipo.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Información de entrada (solo para formularios de salida) -->
                {% if form.TipoRegistro.data == 'salida' and valores_entrada %}
                <div class="form-section entrada-info-section">
                    <h5 class="section-title">
                        <i class="fas fa-clock me-2"></i>
                        Información de Entrada
                    </h5>
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                    <strong>Fecha de Entrada:</strong>
                                    <span class="ms-2">{{ valores_entrada.fecha_entrada }}</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-clock me-2 text-primary"></i>
                                    <strong>Hora de Entrada:</strong>
                                    <span class="ms-2">{{ valores_entrada.hora_entrada }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                {% if valores_entrada.kilometraje %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-road me-2 text-success"></i>
                                    <strong>Kilometraje Entrada:</strong>
                                    <span class="ms-2">{{ valores_entrada.kilometraje }}</span>
                                </div>
                                {% endif %}
                                {% if valores_entrada.horometro %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-tachometer-alt me-2 text-success"></i>
                                    <strong>Horómetro Entrada:</strong>
                                    <span class="ms-2">{{ valores_entrada.horometro }}</span>
                                </div>
                                {% endif %}
                                {% if valores_entrada.horometro2 %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-tachometer-alt me-2 text-success"></i>
                                    <strong>Horómetro 2 Entrada:</strong>
                                    <span class="ms-2">{{ valores_entrada.horometro2 }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Los valores de salida deben ser mayores o iguales a los de entrada
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Datos del equipo (solo para operadores) -->
                <div class="form-section" id="datosEquipo">
                    <h5 class="section-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Datos del Equipo
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.Kilometraje.label(class="form-label") }} <span class="text-danger">*</span>
                            {{ form.Kilometraje(class="form-control" + (" is-invalid" if form.Kilometraje.errors else ""), id="Kilometraje", oninput="validarKilometraje()") }}
                            {% if valores_entrada %}
                                <div class="entrada-reference">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <small class="text-muted">
                                        Valor de entrada: <strong>{{ valores_entrada.kilometraje }}</strong>
                                        ({{ valores_entrada.fecha_entrada }} {{ valores_entrada.hora_entrada }})
                                    </small>
                                </div>
                            {% endif %}
                            <div id="kilometraje-validation" class="validation-message" style="display: none;"></div>
                            {% if form.Kilometraje.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.Kilometraje.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.Horometro.label(class="form-label") }} <span class="text-danger">*</span>
                            {{ form.Horometro(class="form-control" + (" is-invalid" if form.Horometro.errors else ""), id="Horometro", oninput="validarHorometro()") }}
                            {% if valores_entrada %}
                                <div class="entrada-reference">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <small class="text-muted">
                                        Valor de entrada: <strong>{{ valores_entrada.horometro }}</strong>
                                        ({{ valores_entrada.fecha_entrada }} {{ valores_entrada.hora_entrada }})
                                    </small>
                                </div>
                            {% endif %}
                            <div id="horometro-validation" class="validation-message" style="display: none;"></div>
                            {% if form.Horometro.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.Horometro.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Segundo horómetro - Solo para equipos con dos motores -->
                        <div class="col-md-6 mb-3" id="horometro2Section" style="display: none;">
                            {{ form.Horometro2.label(class="form-label") }} <span class="text-danger">*</span>
                            {{ form.Horometro2(class="form-control" + (" is-invalid" if form.Horometro2.errors else ""), id="Horometro2", oninput="validarHorometro2()", style="display: block !important;") }}
                            {% if valores_entrada %}
                                <div class="entrada-reference">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <small class="text-muted">
                                        Valor de entrada: <strong>{{ valores_entrada.horometro2 or 'N/A' }}</strong>
                                        ({{ valores_entrada.fecha_entrada }} {{ valores_entrada.hora_entrada }})
                                    </small>
                                </div>
                            {% endif %}
                            <div id="horometro2-validation" class="validation-message" style="display: none;"></div>
                            {% if form.Horometro2.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.Horometro2.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Cliente (solo si estado es operativo) -->
                <div class="form-section" id="clienteSection">
                    <h5 class="section-title">
                        <i class="fas fa-building"></i>
                        Información del Cliente
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.IdCliente.label(class="form-label") }} <span class="text-danger">*</span>
                            {% if form.IdCliente.render_kw and form.IdCliente.render_kw.get('readonly') %}
                                <!-- Mostrar el cliente como texto no editable -->
                                <div class="form-control-plaintext cliente-readonly p-3 rounded">
                                    <i class="fas fa-building me-2"></i>
                                    <strong>{{ cliente_nombre or 'N/A' }}</strong>
                                </div>
                                <!-- Campo oculto para enviar el valor -->
                                {% if form.IdCliente.data %}
                                <input type="hidden" name="IdCliente" value="{{ form.IdCliente.data }}">
                                {% endif %}
                            {% else %}
                                {{ form.IdCliente(class="form-select" + (" is-invalid" if form.IdCliente.errors else "")) }}
                                {% if form.IdCliente.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.IdCliente.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Fotos - Solo para formularios de entrada -->
                {% if form.TipoRegistro.data == 'entrada' %}
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="fas fa-camera"></i>
                        Evidencia Fotográfica
                    </h5>
                    
                    <div class="row">
                        <!-- Foto del Kilometraje - Solo si es pertinente -->
                        <div class="col-md-6 mb-3" id="fotoKilometraje">
                            <label class="form-label">Foto del Kilometraje</label>
                            <div class="file-upload">
                                {{ form.FotoKilometraje(class="form-control", onchange="previewImage(this, 'previewKilometraje')") }}
                                <label for="FotoKilometraje" class="file-upload-label">
                                    <i class="fas fa-camera me-2"></i>
                                    <span id="textKilometraje">Seleccionar imagen</span>
                                </label>
                            </div>
                            <div id="previewKilometraje" class="image-preview mt-2" style="display: none;">
                                <img id="imgKilometraje" src="" alt="Preview" class="preview-image">
                                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage('FotoKilometraje', 'previewKilometraje', 'textKilometraje')">
                                    <i class="fas fa-trash me-1"></i>Eliminar
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Solo si el equipo tiene odómetro
                            </small>
                        </div>
                        
                        <!-- Foto del Horómetro - Solo si es pertinente -->
                        <div class="col-md-6 mb-3" id="fotoHorometro">
                            <label class="form-label" id="labelFotoHorometro">Foto del Horómetro</label>
                            <div class="file-upload">
                                {{ form.FotoHorometro(class="form-control", onchange="previewImage(this, 'previewHorometro')") }}
                                <label for="FotoHorometro" class="file-upload-label">
                                    <i class="fas fa-camera me-2"></i>
                                    <span id="textHorometro">Seleccionar imagen</span>
                                </label>
                            </div>
                            <div id="previewHorometro" class="image-preview mt-2" style="display: none;">
                                <img id="imgHorometro" src="" alt="Preview" class="preview-image">
                                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage('FotoHorometro', 'previewHorometro', 'textHorometro')">
                                    <i class="fas fa-trash me-1"></i>Eliminar
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Solo si el equipo tiene horómetro
                            </small>
                        </div>
                        
                        <!-- Foto del Segundo Horómetro - Solo para equipos con dos motores -->
                        <div class="col-md-6 mb-3" id="fotoHorometro2" style="display: none;">
                            <label class="form-label" id="labelFotoHorometro2">Foto del Segundo Horómetro</label>
                            <div class="file-upload">
                                {{ form.FotoHorometro2(class="form-control", onchange="previewImage(this, 'previewHorometro2')") }}
                                <label for="FotoHorometro2" class="file-upload-label">
                                    <i class="fas fa-camera me-2"></i>
                                    <span id="textHorometro2">Seleccionar imagen</span>
                                </label>
                            </div>
                            <div id="previewHorometro2" class="image-preview mt-2" style="display: none;">
                                <img id="imgHorometro2" src="" alt="Preview" class="preview-image">
                                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage('FotoHorometro2', 'previewHorometro2', 'textHorometro2')">
                                    <i class="fas fa-trash me-1"></i>Eliminar
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Solo para equipos con dos motores
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Ubicación -->
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Ubicación
                    </h5>
                    
                    <div class="location-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Ubicación actual:</strong> <span id="ubicacionTexto">Obteniendo ubicación...</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Latitud</label>
                            <input type="text" id="latitud" name="latitud" class="form-control" readonly placeholder="Se obtiene automáticamente">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Longitud</label>
                            <input type="text" id="longitud" name="longitud" class="form-control" readonly placeholder="Se obtiene automáticamente">
                        </div>
                        <div class="col-md-12 mb-3">
                            {{ form.Ubicacion.label(class="form-label") }}
                            {{ form.Ubicacion(class="form-control") }}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-outline-primary" onclick="obtenerUbicacion()">
                            <i class="fas fa-location-arrow me-2"></i>Actualizar Ubicación
                        </button>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="form-section">
                    <h5 class="section-title">
                        <i class="fas fa-comment"></i>
                        Observaciones
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.Observacion.label(class="form-label") }}
                            {{ form.Observacion(class="form-control") }}
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="text-center">
                    <a href="{{ url_for('qr_equipos') }}" class="btn btn-volver btn-lg me-3">
                        <i class="fas fa-qrcode me-2"></i>
                        Ver Códigos QR
                    </a>
                    {{ form.submit(class="btn btn-primary btn-lg") }}
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Preview de imágenes
        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                const preview = document.getElementById(previewId);
                const img = preview.querySelector('img');
                const textId = input.id.replace('Foto', 'text');
                const textElement = document.getElementById(textId);
                
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                    textElement.textContent = input.files[0].name;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Eliminar imagen
        function removeImage(inputId, previewId, textId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const textElement = document.getElementById(textId);
            
            input.value = '';
            preview.style.display = 'none';
            textElement.textContent = 'Seleccionar imagen';
        }

        // Obtener ubicación
        function obtenerUbicacion() {
            document.getElementById('ubicacionTexto').textContent = 'Obteniendo ubicación...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Actualizar campos
                        document.getElementById('latitud').value = lat.toFixed(6);
                        document.getElementById('longitud').value = lng.toFixed(6);
                        
                        // Mostrar coordenadas
                        document.getElementById('ubicacionTexto').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                        document.querySelector('input[name="ubicacion"]').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                        
                        // Intentar obtener dirección (sin API key por ahora)
                        // fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=YOUR_API_KEY`)
                        //     .then(response => response.json())
                        //     .then(data => {
                        //         if (data.results && data.results[0]) {
                        //             const ubicacion = data.results[0].formatted;
                        //             document.getElementById('ubicacionTexto').textContent = ubicacion;
                        //             document.querySelector('input[name="ubicacion"]').value = ubicacion;
                        //         }
                        //     })
                        //     .catch(() => {
                        //         // Mantener coordenadas si falla la geocodificación
                        //     });
                    },
                    function(error) {
                        let mensaje = 'No se pudo obtener la ubicación';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensaje = 'Permiso de ubicación denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensaje = 'Ubicación no disponible';
                                break;
                            case error.TIMEOUT:
                                mensaje = 'Tiempo de espera agotado';
                                break;
                        }
                        document.getElementById('ubicacionTexto').textContent = mensaje;
                        console.error('Error obteniendo ubicación:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                document.getElementById('ubicacionTexto').textContent = 'Geolocalización no soportada por este navegador';
            }
        }

        // Controlar visibilidad de campos según cargo
        function controlarCampos() {
            console.log('=== EJECUTANDO controlarCampos() ===');
            const cargoSelect = document.getElementById('IdCargo');
            const estadoSelect = document.getElementById('IdEstadoEquipo');
            console.log('Cargo select:', cargoSelect);
            console.log('Estado select:', estadoSelect);
            
            // Verificar que los elementos críticos existan
            if (!estadoSelect) {
                console.log('❌ ERROR: IdEstadoEquipo no encontrado - saltando controlarCampos()');
                return;
            }
            
            const datosEquipo = document.getElementById('datosEquipo');
            const clienteSection = document.getElementById('clienteSection');
            const fotoKilometraje = document.getElementById('fotoKilometraje');
            const fotoHorometro = document.getElementById('fotoHorometro');
            const fotoHorometro2 = document.getElementById('fotoHorometro2');
            const horometro2Section = document.getElementById('horometro2Section');
            
            // Verificar que los elementos básicos existan
            if (!datosEquipo || !clienteSection) {
                console.log('❌ ERROR: Elementos básicos no encontrados - saltando controlarCampos()');
                return;
            }
            
            // Obtener texto del cargo seleccionado o del cargo de solo lectura
            let cargoTexto = '';
            if (cargoSelect && cargoSelect.options && cargoSelect.options[cargoSelect.selectedIndex]) {
                cargoTexto = cargoSelect.options[cargoSelect.selectedIndex].text.toLowerCase();
            } else {
                // Si es cargo de solo lectura, obtener el texto del div
                const cargoReadonly = document.querySelector('.cargo-readonly');
                if (cargoReadonly) {
                    cargoTexto = cargoReadonly.textContent.toLowerCase();
                }
            }
            
            const esOperador = cargoTexto.includes('operador');
            
            // Verificar si el estado del equipo es "operativo" o "disponible"
            let esOperativo = false;
            if (estadoSelect && estadoSelect.options && estadoSelect.options[estadoSelect.selectedIndex]) {
                const estadoTexto = estadoSelect.options[estadoSelect.selectedIndex].text.toLowerCase();
                esOperativo = estadoTexto.includes('operativo') || estadoTexto.includes('disponible');
            }
            
            console.log('Cargo es operador:', esOperador);
            console.log('Estado es operativo:', esOperativo);
            
            // Actualizar nombres de las fotos según el estado
            actualizarNombresFotos(estadoSelect);
            
            // Mostrar/ocultar campos de datos del equipo
            // SOLO cuando: cargo = "operador" Y estado = "operativo" o "disponible"
            if (esOperador && esOperativo) {
                if (datosEquipo) datosEquipo.style.display = 'block';
                if (fotoKilometraje) fotoKilometraje.style.display = 'block';
                if (fotoHorometro) fotoHorometro.style.display = 'block';
                
                // Verificar si el equipo tiene dos motores
                const tieneDosMotores = {{ equipo.TieneDosMotores|tojson|safe }};
                const esSalida = {{ (form.TipoRegistro.data == 'salida')|tojson|safe }};
                console.log('¿Equipo tiene dos motores?', tieneDosMotores);
                console.log('¿Es formulario de salida?', esSalida);
                
                if (tieneDosMotores) {
                    horometro2Section.style.display = 'block';
                    // Solo mostrar foto en formularios de entrada
                    if (!esSalida && fotoHorometro2) {
                        fotoHorometro2.style.display = 'block';
                    }
                } else {
                    horometro2Section.style.display = 'none';
                    if (fotoHorometro2) {
                        fotoHorometro2.style.display = 'none';
                    }
                }
                
                // Hacer obligatorios los campos de operador
                const kilometrajeField = document.getElementById('Kilometraje');
                const horometroField = document.getElementById('Horometro');
                const horometro2Field = document.getElementById('Horometro2');
                const fotoKilometrajeField = document.getElementById('FotoKilometraje');
                const fotoHorometroField = document.getElementById('FotoHorometro');
                const fotoHorometro2Field = document.getElementById('FotoHorometro2');
                
                if (kilometrajeField) kilometrajeField.required = true;
                if (horometroField) horometroField.required = true;
                if (fotoKilometrajeField) fotoKilometrajeField.required = true;
                if (fotoHorometroField) fotoHorometroField.required = true;
                
                // Hacer obligatorio el segundo horómetro solo si el equipo tiene dos motores
                if (tieneDosMotores) {
                    if (horometro2Field) horometro2Field.required = true;
                    if (fotoHorometro2Field) fotoHorometro2Field.required = true;
                } else {
                    if (horometro2Field) horometro2Field.required = false;
                    if (fotoHorometro2Field) fotoHorometro2Field.required = false;
                }
            } else {
                if (datosEquipo) datosEquipo.style.display = 'none';
                if (fotoKilometraje) fotoKilometraje.style.display = 'none';
                if (fotoHorometro) fotoHorometro.style.display = 'none';
                if (horometro2Section) horometro2Section.style.display = 'none';
                if (fotoHorometro2) fotoHorometro2.style.display = 'none';
                
                // Hacer opcionales los campos de operador cuando no es operador
                const kilometrajeField = document.getElementById('Kilometraje');
                const horometroField = document.getElementById('Horometro');
                const horometro2Field = document.getElementById('Horometro2');
                const fotoKilometrajeField = document.getElementById('FotoKilometraje');
                const fotoHorometroField = document.getElementById('FotoHorometro');
                const fotoHorometro2Field = document.getElementById('FotoHorometro2');
                
                if (kilometrajeField) kilometrajeField.required = false;
                if (horometroField) horometroField.required = false;
                if (horometro2Field) horometro2Field.required = false;
                if (fotoKilometrajeField) fotoKilometrajeField.required = false;
                if (fotoHorometroField) fotoHorometroField.required = false;
                if (fotoHorometro2Field) fotoHorometro2Field.required = false;
            }
            
            // Controlar campo cliente según estado
            let estadoTexto = '';
            if (estadoSelect && estadoSelect.options && estadoSelect.selectedIndex >= 0) {
                estadoTexto = estadoSelect.options[estadoSelect.selectedIndex].text.toLowerCase();
                console.log('Estado detectado del select:', estadoTexto);
            } else {
                // Si es estado de solo lectura, obtener el texto del div
                const estadoReadonly = document.querySelector('.estado-readonly');
                if (estadoReadonly) {
                    estadoTexto = estadoReadonly.textContent.toLowerCase();
                    console.log('Estado detectado del readonly:', estadoTexto);
                }
            }
            esOperativo = estadoTexto.includes('operativo') || estadoTexto.includes('disponible');
            console.log('¿Es operativo?', esOperativo, 'Estado:', estadoTexto);
            
        if (esOperativo) {
            clienteSection.style.display = 'block';
            // Habilitar el campo para que el usuario pueda seleccionar
            habilitarClienteSelect();
        } else {
            clienteSection.style.display = 'block'; // Siempre mostrar
            console.log('Mostrando sección cliente con GRUAS CRANES SAS pre-seleccionado');
            // Asignar cliente por defecto y deshabilitar el campo
            asignarClientePorDefecto();
        }
        
        // LÓGICA ESPECÍFICA PARA HORÓMETRO 2 EN FORMULARIOS DE SALIDA
        const esSalida = {{ (form.TipoRegistro.data == 'salida')|tojson|safe }};
        const tieneDosMotores = {{ (equipo.TieneDosMotores or False)|tojson|safe }};
        
        console.log('=== VERIFICANDO HORÓMETRO 2 PARA SALIDA ===');
        console.log('esSalida:', esSalida);
        console.log('tieneDosMotores:', tieneDosMotores);
        
        // Buscar el elemento nuevamente para asegurar que existe
        const horometro2SectionFresh = document.getElementById('horometro2Section');
        const horometro2FieldFresh = document.getElementById('Horometro2');
        
        console.log('horometro2Section encontrado:', horometro2SectionFresh !== null);
        console.log('horometro2Field encontrado:', horometro2FieldFresh !== null);
        
        if (horometro2SectionFresh) {
            console.log('horometro2Section.innerHTML:', horometro2SectionFresh.innerHTML.substring(0, 200));
            console.log('horometro2Section.className:', horometro2SectionFresh.className);
            console.log('horometro2Section.offsetParent:', horometro2SectionFresh.offsetParent);
        }
        
        // Verificar condiciones adicionales para mostrar Horómetro 2
        let cargoTextoVerificacion = '';
        const cargoSelectVerificacion = document.getElementById('IdCargo');
        if (cargoSelectVerificacion && cargoSelectVerificacion.options && cargoSelectVerificacion.options[cargoSelectVerificacion.selectedIndex]) {
            cargoTextoVerificacion = cargoSelectVerificacion.options[cargoSelectVerificacion.selectedIndex].text.toLowerCase();
        } else {
            const cargoReadonlyVerificacion = document.querySelector('.cargo-readonly');
            if (cargoReadonlyVerificacion) {
                cargoTextoVerificacion = cargoReadonlyVerificacion.textContent.toLowerCase();
            }
        }
        
        let estadoTextoVerificacion = '';
        const estadoSelectVerificacion = document.getElementById('IdEstadoEquipo');
        if (estadoSelectVerificacion && estadoSelectVerificacion.options && estadoSelectVerificacion.options[estadoSelectVerificacion.selectedIndex]) {
            estadoTextoVerificacion = estadoSelectVerificacion.options[estadoSelectVerificacion.selectedIndex].text.toLowerCase();
        } else {
            const estadoReadonlyVerificacion = document.querySelector('.estado-readonly');
            if (estadoReadonlyVerificacion) {
                estadoTextoVerificacion = estadoReadonlyVerificacion.textContent.toLowerCase();
            }
        }
        
        const esOperadorVerificacion = cargoTextoVerificacion.includes('operador');
        const esOperativoVerificacion = estadoTextoVerificacion.includes('operativo') || estadoTextoVerificacion.includes('disponible');
        
        console.log('Cargo detectado en verificación:', cargoTextoVerificacion);
        console.log('Estado detectado en verificación:', estadoTextoVerificacion);
        console.log('esOperadorVerificacion:', esOperadorVerificacion);
        console.log('esOperativoVerificacion:', esOperativoVerificacion);
        
        if (esSalida && tieneDosMotores && esOperadorVerificacion && esOperativoVerificacion) {
            console.log('✅ MOSTRANDO Horómetro 2 en formulario de salida (condiciones cumplidas)');
            
            if (horometro2SectionFresh) {
                console.log('ANTES - horometro2Section.style.display:', horometro2SectionFresh.style.display);
                console.log('ANTES - horometro2Section.style.cssText:', horometro2SectionFresh.style.cssText);
                
                // Múltiples intentos para forzar visibilidad
                horometro2SectionFresh.style.display = 'block';
                horometro2SectionFresh.style.setProperty('display', 'block', 'important');
                horometro2SectionFresh.style.visibility = 'visible';
                horometro2SectionFresh.style.opacity = '1';
                
                console.log('DESPUÉS - horometro2Section.style.display:', horometro2SectionFresh.style.display);
                console.log('DESPUÉS - horometro2Section.style.cssText:', horometro2SectionFresh.style.cssText);
                
                // Verificar si realmente es visible
                const computedStyle = window.getComputedStyle(horometro2SectionFresh);
                console.log('Computed display:', computedStyle.display);
                console.log('Computed visibility:', computedStyle.visibility);
                console.log('Computed opacity:', computedStyle.opacity);
                console.log('Computed height:', computedStyle.height);
                console.log('Computed width:', computedStyle.width);
                
                // Verificar si el elemento está en el DOM
                console.log('Elemento en DOM:', document.body.contains(horometro2SectionFresh));
                console.log('Elemento visible (offsetHeight > 0):', horometro2SectionFresh.offsetHeight > 0);
            } else {
                console.log('❌ ERROR: horometro2Section no encontrado');
            }
            
            // Hacer obligatorio el campo Horómetro 2 en salida
            if (horometro2FieldFresh) {
                horometro2FieldFresh.required = true;
                console.log('horometro2Field marcado como obligatorio');
            } else {
                console.log('❌ ERROR: horometro2Field no encontrado');
            }
        } else {
            console.log('❌ NO se cumple condición para mostrar Horómetro 2 en salida');
            console.log('Condiciones:', {
                esSalida,
                tieneDosMotores,
                esOperadorVerificacion,
                esOperativoVerificacion
            });
        }
        }

        // Función para asignar cliente por defecto (GRUAS CRANES SAS)
        function asignarClientePorDefecto() {
            const clienteSelect = document.getElementById('IdCliente');
            if (clienteSelect) {
                // Seleccionar GRUAS CRANES SAS (ID 6)
                clienteSelect.value = '6';
                // Deshabilitar el campo para que no se pueda modificar
                clienteSelect.disabled = true;
                // Agregar clase para styling
                clienteSelect.classList.add('cliente-auto-asignado');
                console.log('Cliente GRUAS CRANES SAS pre-seleccionado y deshabilitado');
            }
        }

        // Función para habilitar el campo cliente cuando es operativo
        function habilitarClienteSelect() {
            const clienteSelect = document.getElementById('IdCliente');
            if (clienteSelect) {
                // Habilitar el campo
                clienteSelect.disabled = false;
                // Remover clase de styling
                clienteSelect.classList.remove('cliente-auto-asignado');
                // Limpiar selección para que el usuario pueda elegir
                clienteSelect.value = '';
                clienteSelect.selectedIndex = 0;
                console.log('Campo cliente habilitado para selección manual');
            }
        }

        // Función para verificar cliente antes de enviar
        function verificarClienteAntesEnvio() {
            console.log('=== VERIFICANDO CLIENTE ANTES DEL ENVÍO ===');
            const clienteSelect = document.getElementById('IdCliente');
            
            console.log('Campo cliente habilitado:', !clienteSelect.disabled);
            console.log('Valor seleccionado:', clienteSelect.value);
            console.log('Texto seleccionado:', clienteSelect.options[clienteSelect.selectedIndex]?.text);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener ubicación
            obtenerUbicacion();
            
            // Controlar campos inicialmente
            controlarCampos();
            
            // Actualizar nombres de las fotos al cargar la página
            const estadoSelectInit = document.getElementById('IdEstadoEquipo');
            if (estadoSelectInit) {
                actualizarNombresFotos(estadoSelectInit);
            }
            
            // LÓGICA ESPECÍFICA PARA MOSTRAR HORÓMETRO 2 EN SALIDA
            const esSalida = {{ (form.TipoRegistro.data == 'salida')|tojson|safe }};
            const tieneDosMotores = {{ (equipo.TieneDosMotores or False)|tojson|safe }};
            
            console.log('=== INICIALIZACIÓN HORÓMETRO 2 ===');
            console.log('esSalida:', esSalida);
            console.log('tieneDosMotores:', tieneDosMotores);
            
            // Verificar condiciones para mostrar Horómetro 2
            let cargoTextoInit = '';
            const cargoSelectInit = document.getElementById('IdCargo');
            if (cargoSelectInit && cargoSelectInit.options && cargoSelectInit.options[cargoSelectInit.selectedIndex]) {
                cargoTextoInit = cargoSelectInit.options[cargoSelectInit.selectedIndex].text.toLowerCase();
            } else {
                const cargoReadonlyInit = document.querySelector('.cargo-readonly');
                if (cargoReadonlyInit) {
                    cargoTextoInit = cargoReadonlyInit.textContent.toLowerCase();
                }
            }
            
            let estadoTextoInit = '';
            if (estadoSelectInit && estadoSelectInit.options && estadoSelectInit.options[estadoSelectInit.selectedIndex]) {
                estadoTextoInit = estadoSelectInit.options[estadoSelectInit.selectedIndex].text.toLowerCase();
            } else {
                const estadoReadonlyInit = document.querySelector('.estado-readonly');
                if (estadoReadonlyInit) {
                    estadoTextoInit = estadoReadonlyInit.textContent.toLowerCase();
                }
            }
            
            const esOperadorInit = cargoTextoInit.includes('operador');
            const esOperativoInit = estadoTextoInit.includes('operativo') || estadoTextoInit.includes('disponible');
            
            console.log('Cargo detectado en inicialización:', cargoTextoInit);
            console.log('Estado detectado en inicialización:', estadoTextoInit);
            console.log('esOperadorInit:', esOperadorInit);
            console.log('esOperativoInit:', esOperativoInit);
            
            if (esSalida && tieneDosMotores && esOperadorInit && esOperativoInit) {
                console.log('🔧 FORZANDO VISIBILIDAD DEL HORÓMETRO 2');
                
                // Asegurar que el contenedor padre esté visible
                const datosEquipo = document.getElementById('datosEquipo');
                if (datosEquipo) {
                    datosEquipo.style.display = 'block';
                    datosEquipo.style.setProperty('display', 'block', 'important');
                    console.log('✅ datosEquipo mostrado');
                }
                
                const horometro2Section = document.getElementById('horometro2Section');
                
                if (horometro2Section) {
                    console.log('📍 Elemento encontrado, aplicando estilos...');
                    console.log('ANTES - display:', horometro2Section.style.display);
                    console.log('ANTES - computed display:', window.getComputedStyle(horometro2Section).display);
                    console.log('ANTES - parent display:', window.getComputedStyle(horometro2Section.parentElement).display);
                    
                    // Múltiples métodos para forzar visibilidad
                    horometro2Section.style.display = 'block';
                    horometro2Section.style.setProperty('display', 'block', 'important');
                    horometro2Section.style.visibility = 'visible';
                    horometro2Section.style.opacity = '1';
                    horometro2Section.style.height = 'auto';
                    horometro2Section.style.overflow = 'visible';
                    horometro2Section.style.minHeight = '100px';
                    
                    console.log('DESPUÉS - display:', horometro2Section.style.display);
                    console.log('DESPUÉS - computed display:', window.getComputedStyle(horometro2Section).display);
                    console.log('DESPUÉS - computed visibility:', window.getComputedStyle(horometro2Section).visibility);
                    console.log('DESPUÉS - offsetHeight:', horometro2Section.offsetHeight);
                    console.log('DESPUÉS - scrollHeight:', horometro2Section.scrollHeight);
                    console.log('DESPUÉS - clientHeight:', horometro2Section.clientHeight);
                    
                    // Verificar si está realmente visible
                    if (horometro2Section.offsetHeight > 0) {
                        console.log('✅ horometro2Section VISIBLE y con altura');
                    } else {
                        console.log('❌ horometro2Section SIN altura - forzando contenido');
                        // Forzar que el contenido sea visible
                        const horometro2Field = document.getElementById('Horometro2');
                        if (horometro2Field) {
                            horometro2Field.style.display = 'block';
                            horometro2Field.style.setProperty('display', 'block', 'important');
                            horometro2Field.style.visibility = 'visible';
                            horometro2Field.style.opacity = '1';
                            horometro2Field.style.height = 'auto';
                            console.log('✅ Campo Horometro2 forzado a visible');
                        }
                    }
                } else {
                    console.log('❌ horometro2Section no encontrado en DOM');
                    
                    // Buscar todos los elementos que contengan "horometro2"
                    const allElements = document.querySelectorAll('[id*="horometro2"], [class*="horometro2"]');
                    console.log('Elementos relacionados con horometro2:', allElements.length);
                    allElements.forEach((el, index) => {
                        console.log(`Elemento ${index}:`, el.tagName, el.id, el.className);
                    });
                }
            }
            
            // Asignar cliente por defecto si el campo está oculto inicialmente
            const clienteSection = document.getElementById('clienteSection');
            if (clienteSection && clienteSection.style.display === 'none') {
                asignarClientePorDefecto();
            }
            
            // VERIFICACIÓN ADICIONAL DESPUÉS DE 1 SEGUNDO
            setTimeout(function() {
                const esSalida = {{ (form.TipoRegistro.data == 'salida')|tojson|safe }};
                const tieneDosMotores = {{ (equipo.TieneDosMotores or False)|tojson|safe }};
                
                // Re-verificar las condiciones
                let cargoTextoTimeout = '';
                const cargoSelectTimeout = document.getElementById('IdCargo');
                if (cargoSelectTimeout && cargoSelectTimeout.options && cargoSelectTimeout.options[cargoSelectTimeout.selectedIndex]) {
                    cargoTextoTimeout = cargoSelectTimeout.options[cargoSelectTimeout.selectedIndex].text.toLowerCase();
                } else {
                    const cargoReadonlyTimeout = document.querySelector('.cargo-readonly');
                    if (cargoReadonlyTimeout) {
                        cargoTextoTimeout = cargoReadonlyTimeout.textContent.toLowerCase();
                    }
                }
                
                let esOperativoTimeout = false;
                const estadoSelectTimeout = document.getElementById('IdEstadoEquipo');
                if (estadoSelectTimeout && estadoSelectTimeout.options && estadoSelectTimeout.options[estadoSelectTimeout.selectedIndex]) {
                    const estadoTextoTimeout = estadoSelectTimeout.options[estadoSelectTimeout.selectedIndex].text.toLowerCase();
                    esOperativoTimeout = estadoTextoTimeout.includes('operativo') || estadoTextoTimeout.includes('disponible');
                }
                
                const esOperadorTimeout = cargoTextoTimeout.includes('operador');
                
                if (esSalida && tieneDosMotores && esOperadorTimeout && esOperativoTimeout) {
                    console.log('🔍 VERIFICACIÓN TARDÍA DEL HORÓMETRO 2');
                    const horometro2Section = document.getElementById('horometro2Section');
                    if (horometro2Section) {
                        console.log('Estado final - display:', horometro2Section.style.display);
                        console.log('Estado final - computed display:', window.getComputedStyle(horometro2Section).display);
                        console.log('Estado final - offsetHeight:', horometro2Section.offsetHeight);
                        
                        if (horometro2Section.offsetHeight === 0) {
                            console.log('🚨 FORZANDO VISIBILIDAD FINAL');
                            horometro2Section.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important;';
                        }
                    }
                }
            }, 1000);
            
            // Agregar event listeners (solo si los elementos existen)
            const cargoElement = document.getElementById('IdCargo');
            if (cargoElement) {
                cargoElement.addEventListener('change', function() {
                    console.log('Cambio en cargo detectado');
                    controlarCampos();
                });
            }
            
            const estadoElement = document.getElementById('IdEstadoEquipo');
            if (estadoElement) {
                estadoElement.addEventListener('change', function() {
                    console.log('Cambio en estado detectado');
                    controlarCampos();
                });
            }
            
            // Event listener para verificar cliente antes de enviar
            document.getElementById('registroForm').addEventListener('submit', verificarClienteAntesEnvio);
            
            // Event listeners para validación en tiempo real de fecha y hora
            document.getElementById('FechaEmpleado').addEventListener('change', validarFechaHora);
            document.getElementById('HoraEmpleado').addEventListener('change', validarFechaHora);
            document.getElementById('FechaEmpleado').addEventListener('input', validarFechaHora);
            document.getElementById('HoraEmpleado').addEventListener('input', validarFechaHora);
            
            // Los valores de fecha y hora ya vienen configurados desde el servidor
            // con la zona horaria de Colombia, no es necesario sobrescribirlos
        });

        // Variables globales para validación
        let valoresEntrada = null;
        
        // Obtener valores de entrada si están disponibles
        {% if valores_entrada %}
        valoresEntrada = {
            kilometraje: {{ valores_entrada.kilometraje }},
            horometro: {{ valores_entrada.horometro }}
        };
        {% endif %}
        
        // Función para validar kilometraje en tiempo real
        function validarKilometraje() {
            const campo = document.getElementById('Kilometraje');
            const valor = parseFloat(campo.value);
            const mensaje = document.getElementById('kilometraje-validation');
            
            if (!valoresEntrada || !campo.value) {
                mensaje.style.display = 'none';
                campo.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            if (valor >= valoresEntrada.kilometraje) {
                mensaje.innerHTML = '<i class="fas fa-check-circle"></i>Valor válido: mayor o igual al de entrada';
                mensaje.className = 'validation-message valid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-invalid');
                campo.classList.add('is-valid');
            } else {
                mensaje.innerHTML = '<i class="fas fa-exclamation-triangle"></i>Debe ser mayor o igual a ' + valoresEntrada.kilometraje;
                mensaje.className = 'validation-message invalid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-valid');
                campo.classList.add('is-invalid');
            }
        }
        
        // Función para validar horómetro en tiempo real
        function validarHorometro() {
            const campo = document.getElementById('Horometro');
            const valor = parseFloat(campo.value);
            const mensaje = document.getElementById('horometro-validation');
            
            if (!valoresEntrada || !campo.value) {
                mensaje.style.display = 'none';
                campo.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            if (valor >= valoresEntrada.horometro) {
                mensaje.innerHTML = '<i class="fas fa-check-circle"></i>Valor válido: mayor o igual al de entrada';
                mensaje.className = 'validation-message valid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-invalid');
                campo.classList.add('is-valid');
            } else {
                mensaje.innerHTML = '<i class="fas fa-exclamation-triangle"></i>Debe ser mayor o igual a ' + valoresEntrada.horometro;
                mensaje.className = 'validation-message invalid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-valid');
                campo.classList.add('is-invalid');
            }
        }
        
        // Función para validar segundo horómetro en tiempo real
        function validarHorometro2() {
            const campo = document.getElementById('Horometro2');
            const valor = parseFloat(campo.value);
            const mensaje = document.getElementById('horometro2-validation');
            
            if (!valoresEntrada || !campo.value) {
                mensaje.style.display = 'none';
                campo.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            if (valoresEntrada.horometro2 && valor >= valoresEntrada.horometro2) {
                mensaje.innerHTML = '<i class="fas fa-check-circle"></i>Valor válido: mayor o igual al de entrada';
                mensaje.className = 'validation-message valid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-invalid');
                campo.classList.add('is-valid');
            } else if (valoresEntrada.horometro2) {
                mensaje.innerHTML = '<i class="fas fa-exclamation-triangle"></i>Debe ser mayor o igual a ' + valoresEntrada.horometro2;
                mensaje.className = 'validation-message invalid';
                mensaje.style.display = 'block';
                campo.classList.remove('is-valid');
                campo.classList.add('is-invalid');
            } else {
                mensaje.style.display = 'none';
                campo.classList.remove('is-valid', 'is-invalid');
            }
        }
        
        // Función para validar fecha y hora
        function validarFechaHora() {
            const fechaCampo = document.getElementById('FechaEmpleado');
            const horaCampo = document.getElementById('HoraEmpleado');
            const fechaMensaje = document.getElementById('fecha-validation');
            const horaMensaje = document.getElementById('hora-validation');
            
            // Limpiar validaciones anteriores
            fechaCampo.classList.remove('is-valid', 'is-invalid');
            horaCampo.classList.remove('is-valid', 'is-invalid');
            fechaMensaje.style.display = 'none';
            horaMensaje.style.display = 'none';
            
            if (!fechaCampo.value || !horaCampo.value) {
                return false;
            }
            
            const fechaActual = new Date();
            const fechaIngresada = new Date(fechaCampo.value + 'T' + horaCampo.value);
            
            // Validar que no sea una fecha futura
            if (fechaIngresada > fechaActual) {
                fechaCampo.classList.add('is-invalid');
                fechaMensaje.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>La fecha y hora no pueden ser futuras';
                fechaMensaje.style.display = 'block';
                return false;
            }
            
            // Si es formulario de salida, validar contra la entrada
            if (valoresEntrada && valoresEntrada.fecha_entrada && valoresEntrada.hora_entrada) {
                const fechaEntrada = new Date(valoresEntrada.fecha_entrada + 'T' + valoresEntrada.hora_entrada);
                
                // Validar que la salida no sea anterior a la entrada
                if (fechaIngresada < fechaEntrada) {
                    fechaCampo.classList.add('is-invalid');
                    horaCampo.classList.add('is-invalid');
                    fechaMensaje.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>La fecha y hora de salida no pueden ser anteriores a la entrada';
                    fechaMensaje.style.display = 'block';
                    return false;
                }
                
                // Validar que no exceda 24 horas de diferencia
                const diferenciaHoras = (fechaIngresada - fechaEntrada) / (1000 * 60 * 60);
                if (diferenciaHoras > 24) {
                    fechaCampo.classList.add('is-invalid');
                    horaCampo.classList.add('is-invalid');
                    fechaMensaje.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>La diferencia no puede ser mayor a 24 horas';
                    fechaMensaje.style.display = 'block';
                    return false;
                }
                
                // Mostrar información de la diferencia
                if (diferenciaHoras > 0) {
                    const horas = Math.floor(diferenciaHoras);
                    const minutos = Math.floor((diferenciaHoras - horas) * 60);
                    fechaMensaje.innerHTML = `<i class="fas fa-info-circle me-1"></i>Tiempo trabajado: ${horas}h ${minutos}m`;
                    fechaMensaje.style.display = 'block';
                    fechaCampo.classList.add('is-valid');
                    horaCampo.classList.add('is-valid');
                    return true;
                }
            } else {
                // Para formularios de entrada, solo validar que no sea futuro
                fechaCampo.classList.add('is-valid');
                horaCampo.classList.add('is-valid');
                return true;
            }
            
            return true;
        }
        
        // Validación del formulario
        document.getElementById('registroForm').addEventListener('submit', function(e) {
            // Validar fecha y hora usando la función mejorada
            if (!validarFechaHora()) {
                e.preventDefault();
                return false;
            }
            
            // Obtener cargo del select o del div de solo lectura
            let cargoTexto = '';
            const cargoSelect = document.getElementById('IdCargo');
            if (cargoSelect && cargoSelect.options && cargoSelect.options[cargoSelect.selectedIndex]) {
                cargoTexto = cargoSelect.options[cargoSelect.selectedIndex].text.toLowerCase();
            } else {
                const cargoReadonly = document.querySelector('.cargo-readonly');
                if (cargoReadonly) {
                    cargoTexto = cargoReadonly.textContent.toLowerCase();
                }
            }
            
            const esOperador = cargoTexto.includes('operador');
            
            if (esOperador) {
                const kilometraje = document.getElementById('Kilometraje').value;
                const horometro = document.getElementById('Horometro').value;
                const horometro2 = document.getElementById('Horometro2').value;
                
                // Verificar si el equipo tiene dos motores
                const tieneDosMotores = {{ equipo.TieneDosMotores|tojson|safe }};
                
                // Verificar si el cargo es operador y el estado es operativo
                let cargoTexto = '';
                const cargoSelect = document.getElementById('IdCargo');
                if (cargoSelect && cargoSelect.options && cargoSelect.options[cargoSelect.selectedIndex]) {
                    cargoTexto = cargoSelect.options[cargoSelect.selectedIndex].text.toLowerCase();
                }
                
                let estadoTexto = '';
                const estadoSelect = document.getElementById('IdEstadoEquipo');
                if (estadoSelect && estadoSelect.options && estadoSelect.options[estadoSelect.selectedIndex]) {
                    estadoTexto = estadoSelect.options[estadoSelect.selectedIndex].text.toLowerCase();
                }
                
                const esOperador = cargoTexto.includes('operador');
                const esOperativo = estadoTexto.includes('operativo') || estadoTexto.includes('disponible');
                
                // Solo validar si es operador Y operativo
                if (esOperador && esOperativo) {
                    if (!kilometraje || !horometro) {
                        e.preventDefault();
                        alert('Los campos de kilometraje y horómetro son obligatorios para operadores con equipo operativo');
                        return false;
                    }
                    
                    if (tieneDosMotores && !horometro2) {
                        e.preventDefault();
                        alert('El campo del segundo horómetro es obligatorio para equipos con dos motores');
                        return false;
                    }
                }
                
                // Validación adicional con valores de entrada
                if (valoresEntrada) {
                    const kmValor = parseFloat(kilometraje);
                    const hmValor = parseFloat(horometro);
                    const hm2Valor = parseFloat(horometro2);
                    
                    if (kmValor < valoresEntrada.kilometraje) {
                        e.preventDefault();
                        alert(`El kilometraje de salida (${kmValor}) debe ser mayor o igual al de entrada (${valoresEntrada.kilometraje})`);
                        return false;
                    }
                    
                    if (hmValor < valoresEntrada.horometro) {
                        e.preventDefault();
                        alert(`El horómetro de salida (${hmValor}) debe ser mayor o igual al de entrada (${valoresEntrada.horometro})`);
                        return false;
                    }
                    
                    if (tieneDosMotores && valoresEntrada.horometro2 && hm2Valor < valoresEntrada.horometro2) {
                        e.preventDefault();
                        alert(`El segundo horómetro de salida (${hm2Valor}) debe ser mayor o igual al de entrada (${valoresEntrada.horometro2})`);
                        return false;
                    }
                }
            }
        });
        
        // Función para actualizar nombres de las fotos según el estado
        function actualizarNombresFotos(estadoSelect) {
            if (!estadoSelect || !estadoSelect.options || !estadoSelect.options[estadoSelect.selectedIndex]) {
                return;
            }
            
            const estadoTexto = estadoSelect.options[estadoSelect.selectedIndex].text.toLowerCase();
            const esDisponible = estadoTexto.includes('disponible');
            
            // Actualizar etiquetas de las fotos
            const labelFotoHorometro = document.getElementById('labelFotoHorometro');
            const labelFotoHorometro2 = document.getElementById('labelFotoHorometro2');
            
            if (labelFotoHorometro) {
                labelFotoHorometro.textContent = esDisponible ? 'Foto Horómetro Grúa' : 'Foto del Horómetro';
            }
            
            if (labelFotoHorometro2) {
                labelFotoHorometro2.textContent = esDisponible ? 'Foto Horómetro Camión' : 'Foto del Segundo Horómetro';
            }
        }
    </script>
</body>
</html>
